// SERVER CODE
if ( ! ( isServer ) ) exitWith {};

// Wait for CBA and mission to be properly initialized
waitUntil { !isNil "CBA_missionTime" && CBA_missionTime > 5 && !isNil "GRAD_simpleVehicleRespawn_fnc_check" };

params ["_vehObj", ["_respawnWhenNotDead", true], ["_loopInterval", 10]];

// Validate input parameters
if (isNull _vehObj) exitWith {
    diag_log "grad-vehicleRespawn: ERROR - Vehicle object is null";
};

if (_loopInterval < 1) then {
    _loopInterval = 10;
    diag_log "grad-vehicleRespawn: WARNING - Loop interval was too low, set to 10 seconds";
};

// STORE THE VEHICLES DIRECTION, POSITION AND TYPE
private _vehDir = 		 getDir _vehObj;
private _vehPos = 		 getPos _vehObj;
private _vehType = 		 typeOf _vehObj;
private _displayName = 	 getText(configFile >> "CfgVehicles" >> _vehType >> "displayName");

diag_log format ["grad-vehicleRespawn: adding %1 to respawn, respawns when not dead: %2", _displayName, _respawnWhenNotDead];

[{
	params ["_args", "_handle"];
	_args params ["_vehObj", "_respawnWhenNotDead", "_vehType", "_vehDir", "_vehPos", "_displayName"];

	// Check if vehicle still exists
	if (isNull _vehObj) exitWith {
		diag_log format ["grad-vehicleRespawn: Vehicle %1 no longer exists, removing from respawn", _displayName];
		[_handle] call CBA_fnc_removePerFrameHandler;
	};

	// Check if the required function still exists (in case of errors)
	if (isNil "GRAD_simpleVehicleRespawn_fnc_check") exitWith {
		diag_log format ["grad-vehicleRespawn: ERROR - Check function missing for %1", _displayName];
		[_handle] call CBA_fnc_removePerFrameHandler;
	};

	// diag_log format ["checking %1 for respawn", _displayName];
	if (
			_respawnWhenNotDead &&
			{ ( alive _vehObj ) }
		) exitWith {

			diag_log format ["grad-vehicleRespawn: checking vehicle %1 for respawn", _vehObj];
			[_vehObj, _vehType, _respawnWhenNotDead, _vehDir, _vehPos, _handle] call GRAD_simpleVehicleRespawn_fnc_check;
	};

	if ( !( alive _vehObj ) || { !( canMove _vehObj ) } ) exitWith {

			diag_log format ["grad-vehicleRespawn: vehicle %1 dead", _vehObj];
			[_vehObj, _vehType, _respawnWhenNotDead, _vehDir, _vehPos, _handle] call GRAD_simpleVehicleRespawn_fnc_check;
	};

}, _loopInterval, [_vehObj, _respawnWhenNotDead, _vehType, _vehDir, _vehPos, _displayName]] call CBA_fnc_addPerFrameHandler;
